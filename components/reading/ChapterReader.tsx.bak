"use client";

import { useState, useEffect, useRef } from "react";
import { Button } from "@/components/ui/button";
import { ArrowUp, ChevronLeft, ChevronRight } from "lucide-react";
import Link from "next/link";
import Image from "next/image";
import type { Book, Chapter } from "@/lib/types/content";

interface ChapterReaderProps {
  book: Book;
  chapter: Chapter;
}

export function ChapterReader({ book, chapter }: ChapterReaderProps) {
  const [showBackToTop, setShowBackToTop] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  const currentIndex = book.chapters.findIndex(ch => ch.number === chapter.number);
  const prevChapter = currentIndex > 0 ? book.chapters[currentIndex - 1] : null;
  const nextChapter = currentIndex < book.chapters.length - 1 ? book.chapters[currentIndex + 1] : null;

  useEffect(() => {
    const handleScroll = () => {
      if (contentRef.current) {
        const scrollTop = contentRef.current.scrollTop;
        setShowBackToTop(scrollTop > 400);
      }
    };

    const ref = contentRef.current;
    ref?.addEventListener('scroll', handleScroll);
    return () => ref?.removeEventListener('scroll', handleScroll);
  }, []);

  const scrollToTop = () => {
    contentRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
  };

  return (
    <div className="relative w-full min-h-screen bg-lz-second">
      {/* Chapter Content */}
      <div
        ref={contentRef}
        className="relative max-w-4xl mx-auto px-6 py-12 overflow-y-auto h-screen"
      >
        {/* Chapter Header */}
        <div className="text-center mb-12">
          <h1 className="text-4xl md:text-6xl font-display font-bold text-lz-cuart mb-4">
            Capítulo {chapter.number}
          </h1>
          <h2 className="text-2xl md:text-3xl text-lz-terc font-semibold">
            {chapter.title}
          </h2>
        </div>

        {/* Chapter Image */}
        {chapter.image && (
          <div className="relative w-full h-[400px] mb-12 rounded-2xl overflow-hidden">
            <Image
              src={chapter.image}
              alt={`Capítulo ${chapter.number}`}
              fill
              className="object-cover"
            />
          </div>
        )}

        {/* Chapter Text */}
        <div className="prose prose-lg prose-invert max-w-none">
          {chapter.content.split('\n\n').map((paragraph, idx) => (
            <p
              key={idx}
              className="mb-6 text-white leading-relaxed tracking-wide text-justify indent-8"
            >
              {paragraph}
            </p>
          ))}
        </div>

        {/* Reading Info */}
        <div className="mt-12 p-6 bg-lz-prime/50 rounded-xl text-center">
          <p className="text-lz-cuart font-semibold">
            {chapter.wordCount.toLocaleString()} palabras • {chapter.readingTime} min de lectura
          </p>
        </div>

        {/* Navigation Buttons */}
        <div className="flex justify-between items-center mt-12 mb-24">
          {prevChapter ? (
            <Button
              asChild
              variant="outline"
              className="bg-lz-btn-teal hover:bg-lz-btn-darkest text-lz-btn-darkest hover:text-lz-btn-light"
            >
              <Link href={`/lectura/${book.id}/${prevChapter.number}`}>
                <ChevronLeft className="mr-2 h-4 w-4" />
                Capítulo {prevChapter.number}
              </Link>
            </Button>
          ) : (
            <div></div>
          )}

          <Button
            asChild
            variant="outline"
            className="bg-lz-terc hover:bg-lz-prime text-white"
          >
            <Link href="/mapa">Volver al Mapa</Link>
          </Button>

          {nextChapter ? (
            <Button
              asChild
              variant="outline"
              className="bg-lz-btn-teal hover:bg-lz-btn-darkest text-lz-btn-darkest hover:text-lz-btn-light"
            >
              <Link href={`/lectura/${book.id}/${nextChapter.number}`}>
                Capítulo {nextChapter.number}
                <ChevronRight className="ml-2 h-4 w-4" />
              </Link>
            </Button>
          ) : (
            <div></div>
          )}
        </div>
      </div>

      {/* Back to Top Button */}
      {showBackToTop && (
        <Button
          onClick={scrollToTop}
          size="icon"
          className="fixed bottom-8 right-8 rounded-full bg-lz-cuart hover:bg-lz-terc text-lz-prime shadow-lg z-50"
        >
          <ArrowUp className="h-5 w-5" />
        </Button>
      )}
    </div>
  );
}
